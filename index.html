<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤äº’å¼ç å®æˆæœ¬è®¡ç®—å™¨ - è¡¨æ ¼æ‚¬åœä¼˜åŒ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel
        };
    </script>
    <!-- Visualization & Content Choices: (Largely same as previous, UI focus on enhanced interactivity and animations)
        - Card entrance animation: fade in and slide up.
        - Card hover: increased scale and shadow.
        - Input focus: floating label animation.
        - Button hover/active: scale and shadow transformations.
        - Table row hover: REMOVED background highlight and left border.
        - Calculated values: number "rolling" animation on change.
        Justification: This version removes table row hover effects to prevent interference with input fields within table cells, while keeping other card and button animations.
    -->
    <style>
        :root {
            --page-bg: #f0f2f5; 
            --card-bg: #ffffff;
            --text-primary: #1f2937; 
            --text-secondary: #4b5563; 
            --text-muted: #6b7280; 
            --border-color: #e5e7eb; 
            --input-bg: #f9fafb; 
            --input-border: #d1d5db; 
            --input-focus-ring: #38b2ac; 
            --input-label-color: var(--text-muted);
            --input-label-focus-color: var(--accent-teal);
            --table-header-bg: #f3f4f6; 
            --table-header-text: #4b5563; 
            --table-row-even-bg: #f9fafb; 
            /* --table-row-hover-bg: #f0f9ff; Removed */
            --accent-teal: #38b2ac; 
            --accent-teal-light: #e6fffa; 
            --accent-teal-darker: #2c7a7b; 
            --accent-amber: #ed8936; 
            --accent-amber-darker: #dd6b20; 
            --calculated-value-text: var(--accent-teal);
            --card-shadow: 0 6px 24px rgba(0,0,0,0.04), 0 1px 4px rgba(0,0,0,0.03);
            --card-hover-shadow: 0 10px 30px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.06);
        }

        .dark-mode:root {
            --page-bg: #1a1d24; 
            --card-bg: #252a33; 
            --text-primary: #e5e7eb; 
            --text-secondary: #9ca3af; 
            --text-muted: #6b7280; 
            --border-color: #374151; 
            --input-bg: #374151; 
            --input-border: #4b5563; 
            --input-focus-ring: #5eead4; 
            --input-label-color: var(--text-secondary);
            --input-label-focus-color: var(--accent-teal);
            --table-header-bg: #374151; 
            --table-header-text: #e5e7eb; 
            --table-row-even-bg: #374151; 
            /* --table-row-hover-bg: #2c3e50; Removed */
            --accent-teal: #5eead4; 
            --accent-teal-light: rgba(45, 212, 197, 0.1); 
            --accent-teal-darker: #2dd4bf; 
            --accent-amber: #fbbf24; 
            --accent-amber-darker: #fde047; 
            --calculated-value-text: var(--accent-teal);
            --card-shadow: 0 8px 30px rgba(0,0,0,0.2); 
            --card-hover-shadow: 0 12px 35px rgba(0,0,0,0.35);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--page-bg); 
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .section-card { 
            @apply mb-12 p-6 sm:p-8 rounded-xl opacity-0; 
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow); 
            transition: background-color 0.3s, box-shadow 0.3s, transform 0.3s ease-out;
            animation: card-enter 0.5s ease-out forwards;
        }
        
        .section-card:nth-child(1) { animation-delay: 0.1s; }
        .section-card:nth-child(2) { animation-delay: 0.2s; }
        .section-card:nth-child(3) { animation-delay: 0.3s; }
        .section-card:nth-child(4) { animation-delay: 0.4s; }
        .section-card:nth-child(5) { animation-delay: 0.5s; }
        .section-card:nth-child(6) { animation-delay: 0.6s; }
        .section-card:nth-child(7) { animation-delay: 0.7s; }
        .section-card:nth-child(8) { animation-delay: 0.8s; }
        .section-card:nth-child(9) { animation-delay: 0.9s; }


        @keyframes card-enter {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-card:hover {
            transform: translateY(-8px) scale(1.01); 
            box-shadow: var(--card-hover-shadow);
        }
        
        .form-group { @apply mb-6 relative pt-2; } 
        .form-group label { 
            @apply absolute left-4 transition-all duration-200 ease-out pointer-events-none; 
            top: 0.85rem; 
            font-size: 1rem; 
            color: var(--input-label-color);
            background-color: var(--input-bg); 
            padding: 0 0.25rem;
        }
        .input-field:focus + label, 
        .input-field.has-value + label,
        textarea.input-field:focus + label,
        textarea.input-field.has-value + label,
        select.input-field:focus + label,
        select.input-field.has-value + label {
            top: -0.65rem; 
            font-size: 0.75rem; 
            color: var(--input-label-focus-color);
        }
        
        .input-field, .input-field-sm, select.input-field { 
            @apply w-full border rounded-lg shadow-sm transition-colors; 
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
        }
        .dark-mode .input-field::placeholder, 
        .dark-mode .input-field-sm::placeholder { color: var(--text-muted); }
        .input-field:focus, .input-field-sm:focus, select.input-field:focus {
            @apply outline-none ring-2;
            ring-color: var(--input-focus-ring);
            border-color: var(--input-focus-ring); 
        }
        .input-field { @apply px-4 py-2.5; } 
        .input-field-sm { @apply px-2 py-1.5 text-xs; } 
        
        textarea.input-field { resize: both; min-height: 6rem; }

        .btn { @apply px-5 py-2.5 rounded-lg shadow-sm transition-all duration-200 ease-in-out font-medium flex items-center justify-center text-sm; } 
        .btn:hover { transform: translateY(-2px) scale(1.03); filter: brightness(110%); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0px) scale(0.97); filter: brightness(90%); }
        .dark-mode .btn:hover { filter: brightness(120%); }
        .dark-mode .btn:active { filter: brightness(80%); }

        .btn-primary { background-color: var(--accent-teal); color: white; }
        .dark-mode .btn-primary { color: var(--page-bg); } 
        .btn-primary:hover { background-color: var(--accent-teal-darker); }
        .btn-secondary { background-color: var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--input-border); }
        .btn-danger { @apply bg-red-600 text-white hover:bg-red-700; }
        .btn-warning { background-color: var(--accent-amber); color: white; }
        .dark-mode .btn-warning { color: var(--page-bg); } 
        .btn-warning:hover { background-color: var(--accent-amber-darker); }
        .btn-gemini {
            background-color: var(--accent-amber); color: white;
            @apply mt-3; 
        }
        .dark-mode .btn-gemini { color: var(--page-bg); }
        .btn-gemini:hover { background-color: var(--accent-amber-darker); }
        
        .section-title { 
            @apply text-xl sm:text-2xl font-semibold mb-8 pb-4; 
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }
       
        .table-header { 
            font-medium;
            background-color: var(--table-header-bg); 
            color: var(--table-header-text);
        }
        .table-body tr { background-color: var(--card-bg); /* Removed transition */ position:relative; } 
        .dark-mode .table-body tr { background-color: transparent; } 
        .table-body tr:nth-child(even) { background-color: var(--table-row-even-bg); }
        /* Removed .table-body tr:hover and .table-body tr:hover::before styles */


        .compact-table { table-layout: auto; width: 100%; } 
        .compact-table th, .compact-table td { @apply px-2 py-2 text-xs text-center; vertical-align: middle;} 
        .compact-table .col-name { @apply text-left; width: 25%; min-width: 100px;} 
        .compact-table .col-price { width: 13%; min-width: 70px;}
        .compact-table .col-unit { width: 10%; min-width: 50px;}
        .compact-table .col-number { width: 12%; min-width: 60px;}
        .compact-table .col-action { width: 10%; min-width: 50px;}
        .compact-table .input-field-sm { @apply py-1 px-1.5 w-full; }
        .compact-table .input-field-sm.name-field { @apply text-left; }


        .calculated-value { font-weight: 600; color: var(--calculated-value-text); transition: color 0.3s, transform 0.3s; }
        .value-changed {
            animation: value-pop 0.5s ease-out;
        }
        @keyframes value-pop {
            0% { transform: scale(1); color: var(--calculated-value-text); }
            50% { transform: scale(1.15); color: var(--accent-amber); }
            100% { transform: scale(1); color: var(--calculated-value-text); }
        }


        .summary-item { @apply flex justify-between items-center py-2.5; border-bottom: 1px solid var(--border-color); } 
        .summary-item:last-child { border-bottom: none; }
        .total-summary-item { border-top: 2px solid var(--accent-teal); color: var(--accent-teal); @apply pt-2.5; } 

        .chart-container { position: relative; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; height: 300px; max-height: 350px; @apply mt-6; } 
        @media (min-width: 768px) { .chart-container { height: 320px; } }
        
        .modal { @apply fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full flex justify-center items-center z-50 p-4; }
        .modal-content { @apply p-6 sm:p-8 rounded-lg shadow-xl max-w-2xl w-full mx-auto; background-color: var(--card-bg); }
        .icon-spacing { @apply mr-2 text-base; }

        .srp-box { background-color: var(--accent-teal-light); border-radius: 0.5rem; padding: 1rem; text-align: center; @apply mt-4; } 
        .srp-box .srp-label { color: var(--accent-teal-darker); font-size: 0.875rem; }
        .dark-mode .srp-box .srp-label { color: var(--accent-teal); }
        .srp-box .srp-value { color: var(--accent-teal); font-size: 1.875rem; font-weight: 700; }
        .dark-mode .srp-box .srp-value { color: var(--accent-teal); }

        #themeToggle {
            @apply fixed top-4 right-4 p-2.5 rounded-full shadow-lg z-[70]; 
            background-color: var(--card-bg); color: var(--text-secondary); border: 1px solid var(--border-color);
        }
        #themeToggle:hover { background-color: var(--input-bg); }
        
        .loading-overlay, .gemini-loading-overlay {
            @apply fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-[60]; 
            color: white; font-size: 1.25rem;
        }
        .dark-mode .loading-overlay, .dark-mode .gemini-loading-overlay { background-color: rgba(0,0,0,0.8); }
        
        p.text-sm { @apply leading-relaxed mb-8; } 

        #geminiResponseModal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        #geminiResponseText {
            white-space: pre-wrap; 
            font-family: monospace;
            background-color: var(--input-bg);
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            max-height: 60vh;
            overflow-y: auto;
        }
        .btn-gemini .spinner {
            @apply inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin ml-2;
        }

    </style>
</head>
<body> 
    <div id="loadingOverlay" class="loading-overlay hidden">æ­£åœ¨åŠ è½½...</div>
    <div id="geminiLoadingOverlay" class="gemini-loading-overlay hidden">âœ¨ AI æ­£åœ¨æ€è€ƒä¸­...<span class="spinner"></span></div>

    <button id="themeToggle" title="åˆ‡æ¢æ—¥å¤œæ¨¡å¼">
        <span id="themeIcon">â˜€ï¸</span>
    </button>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl"> 
        <header class="mb-12 text-center"> 
            <h1 class="text-3xl sm:text-4xl font-bold" style="color: var(--accent-teal);">äº¤äº’å¼ç å®æˆæœ¬è®¡ç®—å™¨</h1>
            <p style="color: var(--text-secondary);" class="mt-3 text-base sm:text-lg">ç²¾ç»†åŒ–æˆæœ¬æ ¸ç®—ï¼ŒåŠ©åŠ›æ‚¨çš„ç å®è®¾è®¡äº‹ä¸šã€‚</p>
        </header>

        <section id="archiveSection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">ğŸ—ƒï¸</span>äº§å“å­˜æ¡£ä¸ç®¡ç† (Firestore)</h2>
            <p class="text-sm" style="color: var(--text-muted);">äº§å“æ•°æ®å°†ä¿å­˜åœ¨äº‘ç«¯æ•°æ®åº“ã€‚åŠ è½½åˆ—è¡¨å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-6 items-end mt-6"> 
                <div class="form-group lg:col-span-2">
                    <select id="savedProducts" class="input-field"></select>
                    <label for="savedProducts" class="sr-only">å·²å­˜æ¡£äº§å“åˆ—è¡¨</label>
                </div>
                <div class="form-group"><button id="loadProductBtn" class="btn btn-secondary w-full"><span class="icon-spacing">ğŸ“‚</span>åŠ è½½</button></div>
                <div class="form-group"><button id="deleteProductBtn" class="btn btn-danger w-full"><span class="icon-spacing">ğŸ—‘ï¸</span>åˆ é™¤</button></div>
                <div class="form-group md:col-span-2 lg:col-span-4"><button id="saveProductBtn" class="btn btn-primary w-full"><span class="icon-spacing">ğŸ’¾</span>ä¿å­˜å½“å‰äº§å“</button></div>
            </div>
            <div class="mt-8 text-center"><button id="generateReportBtn" class="btn btn-warning"><span class="icon-spacing">ğŸ“„</span>ç”Ÿæˆäº§å“æŠ¥å‘Š</button></div>
        </section>

        <section id="productInfoSection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">â„¹ï¸</span>1. äº§å“åŸºæœ¬ä¿¡æ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-0"> 
                <div class="form-group">
                    <input type="text" id="productSKU" class="input-field" placeholder=" "> 
                    <label for="productSKU">äº§å“æ¬¾å¼ç¼–å· (SKU)</label>
                </div>
                <div class="form-group">
                    <input type="text" id="productName" class="input-field" placeholder=" ">
                    <label for="productName">äº§å“åç§°</label>
                </div>
                <div class="form-group">
                    <input type="date" id="designDate" class="input-field"> 
                    <label for="designDate">è®¾è®¡æ—¥æœŸ</label>
                </div>
                <div class="form-group">
                    <input type="text" id="designerName" class="input-field" placeholder=" ">
                    <label for="designerName">è®¾è®¡å¸ˆ</label>
                </div>
                <div class="form-group md:col-span-2">
                    <textarea id="productDescription" rows="3" class="input-field" placeholder=" "></textarea>
                    <label for="productDescription">äº§å“æè¿°</label>
                    <button id="enhanceDescriptionBtn" class="btn btn-gemini w-full sm:w-auto"><span class="icon-spacing">âœ¨</span>ä¼˜åŒ–æè¿° (AI)<span class="spinner hidden"></span></button>
                </div>
            </div>
        </section>

        <section id="gemstoneCostSection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">ğŸ’</span>2. å®çŸ³æˆæœ¬</h2>
            <p class="text-sm" style="color: var(--text-muted);">åˆ—å‡ºæ‰€æœ‰å®çŸ³ç±»ææ–™çš„æˆæœ¬ã€‚</p>
            <div class="overflow-x-auto mt-6">
                <table class="min-w-full divide-y rounded-md compact-table" style="border: 1px solid var(--border-color); divide-color: var(--border-color);">
                    <thead class="table-header"><tr><th class="col-name">åç§°/è§„æ ¼</th><th class="col-price">è´­å…¥å•ä»·(Â¥)</th><th class="col-unit">è´­å…¥å•ä½</th><th class="col-number">å•ä½æ•°é‡</th><th class="col-price">å•ä½æˆæœ¬(Â¥)</th><th class="col-number">ä½¿ç”¨æ•°é‡</th><th class="col-price">å°è®¡(Â¥)</th><th class="col-action">æ“ä½œ</th></tr></thead>
                    <tbody id="gemstoneRows" class="table-body divide-y" style="divide-color: var(--border-color);"></tbody>
                </table>
            </div>
            <div class="flex justify-between items-center mt-6"> 
                <button id="addGemstoneRow" class="btn btn-primary btn-sm"><span class="icon-spacing">âœ¨</span>æ·»åŠ å®çŸ³</button>
                <div class="text-lg"><strong>å®çŸ³æ€»æˆæœ¬: Â¥<span id="totalGemstoneCost" class="calculated-value">0.00</span></strong></div>
            </div>
        </section>

        <section id="accessoryCostSection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">ğŸ”—</span>3. é…ä»¶æˆæœ¬</h2>
            <p class="text-sm" style="color: var(--text-muted);">åˆ—å‡ºæ‰€æœ‰é‡‘å±é…ä»¶ã€çº¿æç­‰éå®çŸ³ç±»ææ–™çš„æˆæœ¬ã€‚</p>
            <div class="overflow-x-auto mt-6">
                 <table class="min-w-full divide-y rounded-md compact-table" style="border: 1px solid var(--border-color); divide-color: var(--border-color);">
                    <thead class="table-header"><tr><th class="col-name">åç§°/è§„æ ¼</th><th class="col-price">è´­å…¥å•ä»·(Â¥)</th><th class="col-unit">è´­å…¥å•ä½</th><th class="col-number">å•ä½æ•°é‡</th><th class="col-price">å•ä½æˆæœ¬(Â¥)</th><th class="col-number">ä½¿ç”¨æ•°é‡</th><th class="col-price">å°è®¡(Â¥)</th><th class="col-action">æ“ä½œ</th></tr></thead>
                    <tbody id="accessoryRows" class="table-body divide-y" style="divide-color: var(--border-color);"></tbody>
                </table>
            </div>
            <div class="flex justify-between items-center mt-6"> 
                <button id="addAccessoryRow" class="btn btn-primary btn-sm"><span class="icon-spacing">ğŸ”—</span>æ·»åŠ é…ä»¶</button>
                <div class="text-right text-lg"><strong>é…ä»¶æ€»æˆæœ¬: Â¥<span id="totalAccessoryCost" class="calculated-value">0.00</span></strong></div>
            </div>
        </section>
        
        <section id="designOperatingCostSection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">âš™ï¸</span>4. è®¾è®¡ä¸è¿è¥æˆæœ¬</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-0 items-center">
                <div class="form-group"><input type="number" id="fixedDesignFee" class="input-field" value="0" min="0" step="1" placeholder=" "><label for="fixedDesignFee">å›ºå®šè®¾è®¡è´¹ (Â¥)</label></div>
                <div class="form-group"><input type="number" id="allocatedOperatingCost" class="input-field" value="0" min="0" step="1" placeholder=" "><label for="allocatedOperatingCost">è¿è¥æˆæœ¬åˆ†æ‘Š (Â¥)</label></div>
            </div>
        </section>

        <section id="wastageCostSection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">ğŸ“‰</span>5. æŸè€—æˆæœ¬</h2>
            <p class="text-sm" style="color: var(--text-muted);">ä¼°ç®—åœ¨åˆ¶ä½œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿçš„ææ–™æŸè€—ã€‚è¿™é€šå¸¸æ˜¯å®çŸ³å’Œé…ä»¶æ€»æˆæœ¬çš„ä¸€ä¸ªç™¾åˆ†æ¯”ã€‚</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-0 items-center">
                <div class="form-group"><input type="number" id="wastageRate" class="input-field" value="5" min="0" step="0.1" placeholder=" "><label for="wastageRate">é¢„ä¼°æŸè€—ç‡ (%)</label></div>
                <div class="text-lg md:text-right form-group md:pt-6"><strong>æŸè€—æˆæœ¬: Â¥<span id="wastageCost" class="calculated-value">0.00</span></strong></div>
            </div>
        </section>

        <section id="laborCostSection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">ğŸ› ï¸</span>6. äººå·¥æˆæœ¬ (åˆ¶ä½œ)</h2>
            <p class="text-sm" style="color: var(--text-muted);">è¯„ä¼°æ‚¨åœ¨å®é™…åˆ¶ä½œä¸ŠæŠ•å…¥çš„æ—¶é—´ä»·å€¼ã€‚</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-0 items-center">
                <div class="form-group"><input type="number" id="laborHours" class="input-field" value="0.75" min="0" step="0.01" placeholder=" "><label for="laborHours">é¢„ä¼°åˆ¶ä½œå·¥æ—¶ (å°æ—¶)</label></div>
                <div class="form-group"><input type="number" id="hourlyRate" class="input-field" value="60" min="0" step="1" placeholder=" "><label for="hourlyRate">æ—¶è–ªæ ‡å‡† (Â¥/å°æ—¶)</label></div>
                <div class="text-lg md:text-right form-group md:pt-6"><strong>äººå·¥æˆæœ¬: Â¥<span id="laborCost" class="calculated-value">0.00</span></strong></div>
            </div>
        </section>

        <section id="packagingCostSection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">ğŸ“¦</span>7. åŒ…è£…æˆæœ¬</h2>
            <p class="text-sm" style="color: var(--text-muted);">è®°å½•æ‰€æœ‰ç”¨äºæˆå“åŒ…è£…çš„ææ–™æˆæœ¬ã€‚è¡¨æ ¼ç»“æ„å·²æ›´æ–°ï¼Œç±»ä¼¼ææ–™æˆæœ¬ã€‚</p>
             <div class="overflow-x-auto mt-6">
                <table class="min-w-full divide-y rounded-md compact-table" style="border: 1px solid var(--border-color); divide-color: var(--border-color);">
                    <thead class="table-header"><tr><th class="col-name">åŒ…è£…é¡¹</th><th class="col-price">è´­å…¥å•ä»·(Â¥)</th><th class="col-unit">è´­å…¥å•ä½</th><th class="col-number">å•ä½æ•°é‡</th><th class="col-price">å•ä½æˆæœ¬(Â¥)</th><th class="col-number">ä½¿ç”¨æ•°é‡</th><th class="col-price">å°è®¡(Â¥)</th><th class="col-action">æ“ä½œ</th></tr></thead>
                    <tbody id="packagingRows" class="table-body divide-y" style="divide-color: var(--border-color);"></tbody>
                </table>
            </div>
            <div class="flex justify-between items-center mt-6"> 
                <button id="addPackagingRow" class="btn btn-primary btn-sm"><span class="icon-spacing">ğŸ</span>æ·»åŠ åŒ…è£…é¡¹</button>
                <div class="text-right text-lg"><strong>åŒ…è£…æ€»æˆæœ¬: Â¥<span id="totalPackagingCost" class="calculated-value">0.00</span></strong></div>
            </div>
        </section>

        <section id="summarySection" class="section-card">
            <h2 class="section-title"><span class="icon-spacing">ğŸ“Š</span>8. æ€»æˆæœ¬ä¸å®šä»·å»ºè®®</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-medium mb-6 mt-0" style="color: var(--text-secondary);">æˆæœ¬æ˜ç»†æ±‡æ€»</h3>
                    <div class="space-y-2 text-sm"> 
                        <div class="summary-item"><span>å®çŸ³æ€»æˆæœ¬:</span><span class="font-medium">Â¥<span id="summaryGemstoneCost">0.00</span></span></div>
                        <div class="summary-item"><span>é…ä»¶æ€»æˆæœ¬:</span><span class="font-medium">Â¥<span id="summaryAccessoryCost">0.00</span></span></div>
                        <div class="summary-item"><span>å›ºå®šè®¾è®¡è´¹:</span><span class="font-medium">Â¥<span id="summaryDesignFee">0.00</span></span></div>
                        <div class="summary-item"><span>è¿è¥æˆæœ¬åˆ†æ‘Š:</span><span class="font-medium">Â¥<span id="summaryOperatingCost">0.00</span></span></div>
                        <div class="summary-item"><span>æŸè€—æˆæœ¬:</span><span class="font-medium">Â¥<span id="summaryWastageCost">0.00</span></span></div>
                        <div class="summary-item"><span>äººå·¥æˆæœ¬ (åˆ¶ä½œ):</span><span class="font-medium">Â¥<span id="summaryLaborCost">0.00</span></span></div>
                        <div class="summary-item"><span>åŒ…è£…æ€»æˆæœ¬:</span><span class="font-medium">Â¥<span id="summaryPackagingCost">0.00</span></span></div>
                        <div class="summary-item total-summary-item mt-3 pt-3"><strong class="text-lg">ç›´æ¥æ€»æˆæœ¬:</strong><strong class="text-lg">Â¥<span id="totalDirectCost" class="calculated-value">0.00</span></strong></div>
                    </div>
                    <div class="mt-8 form-group"><input type="number" id="profitMarkup" class="input-field" value="3" min="1" step="0.1" placeholder=" "><label for="profitMarkup">ç›®æ ‡åˆ©æ¶¦å€æ•°</label></div>
                    <div class="mt-4 srp-box"><p class="srp-label">å»ºè®®é›¶å”®ä»· (SRP):</p><p class="srp-value">Â¥<span id="suggestedRetailPrice">0.00</span></p></div>
                     <div class="mt-8 text-center">
                        <button id="getCostAnalysisBtn" class="btn btn-gemini w-full sm:w-auto"><span class="icon-spacing">âœ¨</span>è·å–æˆæœ¬åˆ†æ (AI)<span class="spinner hidden"></span></button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-medium mb-6 mt-0" style="color: var(--text-secondary);">æˆæœ¬æ„æˆå›¾è¡¨</h3>
                     <div class="chart-container"><canvas id="costBreakdownChart"></canvas></div>
                </div>
            </div>
        </section>

        <div id="geminiResponseModal" class="modal hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4 pb-2" style="border-bottom: 1px solid var(--border-color);">
                    <h2 id="geminiModalTitle" class="text-xl font-semibold" style="color: var(--accent-teal);">AI åŠ©æ‰‹</h2>
                    <button id="closeGeminiModalBtn" style="color: var(--text-muted);" class="hover:text-red-500 text-3xl leading-none">&times;</button>
                </div>
                <div id="geminiResponseText" class="text-sm leading-relaxed" style="color: var(--text-primary);">
                    </div>
                 <div class="mt-6 text-right">
                    <button id="copyGeminiResponseBtn" class="btn btn-secondary btn-sm mr-2">å¤åˆ¶å†…å®¹</button>
                    <button id="closeGeminiModalBtnSecondary" class="btn btn-secondary btn-sm">å…³é—­</button>
                </div>
            </div>
        </div>


        <div id="reportModal" class="modal hidden">
            <div class="modal-content overflow-y-auto max-h-[90vh]">
                <div class="flex justify-between items-center mb-6 pb-3" style="border-bottom: 1px solid var(--border-color);"><h2 class="text-2xl font-semibold" style="color: var(--accent-teal);">äº§å“æˆæœ¬æŠ¥å‘Š</h2><button id="closeReportModalBtn" style="color: var(--text-muted);" class="hover:text-red-500 text-3xl leading-none">&times;</button></div>
                <div id="reportContent" class="space-y-4 text-sm"></div>
                 <div class="mt-8 text-right space-x-3"><button onclick="window.print()" class="btn btn-primary"><span class="icon-spacing">ğŸ–¨ï¸</span>æ‰“å°æŠ¥å‘Š</button><button id="closeReportModalBtnSecondary" class="btn btn-secondary">å…³é—­</button></div>
            </div>
        </div>

        <footer class="text-center mt-12 py-8" style="border-top: 1px solid var(--border-color);">
            <p class="text-sm" style="color: var(--text-muted);">&copy; <span id="currentYear"></span> ç å®æˆæœ¬è®¡ç®—å™¨. ä¸“ä¸ºç å®è®¾è®¡å¸ˆæ‰“é€ ã€‚</p>
        </footer>
    </div>

<script type="module">
    const { 
        initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
        getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel
    } = window.firebaseSDK;

    let gemstoneRowIdx = 0;
    let accessoryRowIdx = 0;
    let packagingRowIdx = 0;
    let costChart;
    const themeKey = 'jewelryCalculatorTheme';

    let db, auth, userId, userProductsCollection;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-jewelry-cost';

    const el = {
        loadingOverlay: document.getElementById('loadingOverlay'),
        geminiLoadingOverlay: document.getElementById('geminiLoadingOverlay'),
        themeToggle: document.getElementById('themeToggle'),
        themeIcon: document.getElementById('themeIcon'),
        productSKU: document.getElementById('productSKU'),
        productName: document.getElementById('productName'),
        designDate: document.getElementById('designDate'),
        designerName: document.getElementById('designerName'),
        productDescription: document.getElementById('productDescription'),
        enhanceDescriptionBtn: document.getElementById('enhanceDescriptionBtn'),
        gemstoneRows: document.getElementById('gemstoneRows'),
        addGemstoneRowBtn: document.getElementById('addGemstoneRow'),
        totalGemstoneCostSpan: document.getElementById('totalGemstoneCost'),
        accessoryRows: document.getElementById('accessoryRows'),
        addAccessoryRowBtn: document.getElementById('addAccessoryRow'),
        totalAccessoryCostSpan: document.getElementById('totalAccessoryCost'),
        fixedDesignFeeInput: document.getElementById('fixedDesignFee'),
        allocatedOperatingCostInput: document.getElementById('allocatedOperatingCost'),
        wastageRateInput: document.getElementById('wastageRate'),
        wastageCostSpan: document.getElementById('wastageCost'),
        laborHoursInput: document.getElementById('laborHours'),
        hourlyRateInput: document.getElementById('hourlyRate'),
        laborCostSpan: document.getElementById('laborCost'),
        packagingRows: document.getElementById('packagingRows'),
        addPackagingRowBtn: document.getElementById('addPackagingRow'),
        totalPackagingCostSpan: document.getElementById('totalPackagingCost'),
        summaryGemstoneCost: document.getElementById('summaryGemstoneCost'),
        summaryAccessoryCost: document.getElementById('summaryAccessoryCost'),
        summaryDesignFee: document.getElementById('summaryDesignFee'),
        summaryOperatingCost: document.getElementById('summaryOperatingCost'),
        summaryWastageCostSpan: document.getElementById('summaryWastageCost'),
        summaryLaborCostSpan: document.getElementById('summaryLaborCost'),
        summaryPackagingCostSpan: document.getElementById('summaryPackagingCost'),
        totalDirectCostSpan: document.getElementById('totalDirectCost'),
        profitMarkupInput: document.getElementById('profitMarkup'),
        suggestedRetailPriceSpan: document.getElementById('suggestedRetailPrice'),
        getCostAnalysisBtn: document.getElementById('getCostAnalysisBtn'),
        costBreakdownChartCanvas: document.getElementById('costBreakdownChart').getContext('2d'),
        currentYearSpan: document.querySelector('footer p span'), 
        savedProductsSelect: document.getElementById('savedProducts'),
        saveProductBtn: document.getElementById('saveProductBtn'),
        loadProductBtn: document.getElementById('loadProductBtn'),
        deleteProductBtn: document.getElementById('deleteProductBtn'),
        generateReportBtn: document.getElementById('generateReportBtn'),
        reportModal: document.getElementById('reportModal'),
        reportContent: document.getElementById('reportContent'),
        closeReportModalBtn: document.getElementById('closeReportModalBtn'),
        closeReportModalBtnSecondary: document.getElementById('closeReportModalBtnSecondary'),
        geminiResponseModal: document.getElementById('geminiResponseModal'),
        geminiModalTitle: document.getElementById('geminiModalTitle'),
        geminiResponseText: document.getElementById('geminiResponseText'),
        closeGeminiModalBtn: document.getElementById('closeGeminiModalBtn'),
        closeGeminiModalBtnSecondary: document.getElementById('closeGeminiModalBtnSecondary'),
        copyGeminiResponseBtn: document.getElementById('copyGeminiResponseBtn')
    };

    function showLoading(show) {
        el.loadingOverlay.classList.toggle('hidden', !show);
    }
    function showGeminiLoading(show, buttonElement) {
        el.geminiLoadingOverlay.classList.toggle('hidden', !show);
        if (buttonElement) {
            buttonElement.disabled = show;
            const spinner = buttonElement.querySelector('.spinner');
            if (spinner) spinner.classList.toggle('hidden', !show);
            else if (show) { 
                const newSpinner = document.createElement('span');
                newSpinner.className = 'spinner';
                buttonElement.appendChild(newSpinner);
            }
        }
    }
    
    function handleInputFocus(event) {
        event.target.classList.add('has-value'); 
    }
    function handleInputBlur(event) {
        if (!event.target.value && event.target.type !== 'date') { 
            event.target.classList.remove('has-value');
        }
    }
    function setupInputInteractions() {
        const inputs = document.querySelectorAll('.input-field, .input-field-sm');
        inputs.forEach(input => {
            if (input.value || (input.type === 'date' && input.value) ) { 
                input.classList.add('has-value');
            } else if (input.type === 'date' && !input.value) { 
                 input.classList.remove('has-value');
            }

            input.addEventListener('focus', handleInputFocus);
            input.addEventListener('blur', handleInputBlur);
            input.addEventListener('change', () => { 
                 if (input.type === 'date') {
                    input.classList.toggle('has-value', input.value !== '');
                 }
            });
        });
    }


    async function initializeFirebase() {
        showLoading(true);
        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                alert("æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼šç¼ºå°‘é…ç½®ä¿¡æ¯ã€‚è¯·ç¡®ä¿ Firebase é…ç½®å·²æ­£ç¡®è®¾ç½®ã€‚");
                showLoading(false);
                [el.saveProductBtn, el.loadProductBtn, el.deleteProductBtn].forEach(btn => {
                    btn.disabled = true; btn.title = "æ•°æ®åº“æœªé…ç½®";
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                el.savedProductsSelect.disabled = true;
                return;
            }
            
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); 

            onAuthStateChanged(auth, async (user) => {
                showLoading(true); 
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated user:", userId);
                    userProductsCollection = collection(db, `artifacts/${appId}/users/${userId}/jewelry_products`);
                    await populateSavedProductsSelect(); 
                } else {
                    console.log("User is signed out or auth state not yet determined. Attempting sign-in.");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else { await signInAnonymously(auth); }
                    } catch (authError) {
                         console.error("Firebase auth error during re-attempt:", authError);
                         alert("ç”¨æˆ·è®¤è¯å¤±è´¥: " + authError.message);
                         showLoading(false);
                    }
                }
            });
            
            if (!auth.currentUser) {
                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }
            } else { 
                if (!userId) { 
                    userId = auth.currentUser.uid;
                    userProductsCollection = collection(db, `artifacts/${appId}/users/${userId}/jewelry_products`);
                    await populateSavedProductsSelect();
                }
                showLoading(false); 
            }
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: " + error.message);
            showLoading(false);
        }
    }

    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark-mode');
            el.themeIcon.textContent = 'ğŸŒ™';
        } else {
            document.documentElement.classList.remove('dark-mode');
            el.themeIcon.textContent = 'â˜€ï¸';
        }
        if (costChart) {
            updateChartColors(theme);
        }
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem(themeKey, newTheme);
        applyTheme(newTheme);
    }
    
    function updateChartColors(theme) {
        if (!costChart) return;
        const isDark = theme === 'dark';
        setTimeout(() => {
            const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
            const tooltipBgColor = isDark ? getComputedStyle(document.documentElement).getPropertyValue('--input-bg').trim() : '#333';
            const tooltipTitleColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
            const tooltipBodyColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();

            costChart.options.plugins.legend.labels.color = legendColor;
            costChart.options.plugins.tooltip.backgroundColor = tooltipBgColor;
            costChart.options.plugins.tooltip.titleColor = tooltipTitleColor;
            costChart.options.plugins.tooltip.bodyColor = tooltipBodyColor;
            costChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim(); 
            costChart.update();
        }, 50);
    }

    function formatCurrency(value) {
        const num = parseFloat(value);
        return isNaN(num) ? '0.00' : num.toFixed(2);
    }

    function createMaterialRowHTML(type, idx) {
        return `
            <td class="px-1 py-1 col-name"><input type="text" class="input-field-sm name-field ${type}-name" placeholder=" "></td>
            <td class="px-1 py-1 col-price"><input type="number" class="input-field-sm max-w-24 ${type}-purchase-price" placeholder=" " min="0" step="0.01"></td>
            <td class="px-1 py-1 col-unit"><input type="text" class="input-field-sm max-w-20 ${type}-purchase-unit" placeholder=" "></td>
            <td class="px-1 py-1 col-number"><input type="number" class="input-field-sm max-w-20 ${type}-unit-quantity" placeholder=" " min="0.001" step="0.001"></td>
            <td class="px-1 py-1 text-xs sm:text-sm ${type}-unit-cost text-center col-price">0.00</td>
            <td class="px-1 py-1 col-number"><input type="number" class="input-field-sm max-w-20 ${type}-quantity-used" placeholder=" " min="0" step="0.001"></td>
            <td class="px-1 py-1 text-xs sm:text-sm ${type}-subtotal text-center col-price">0.00</td>
            <td class="px-1 py-1 text-center col-action"><button class="btn btn-danger btn-sm text-xs !p-1" onclick="window.removeRow('${type}Row-${idx}')">ç§»é™¤</button></td>
        `;
    }
     function createPackagingRowHTML(idx) { 
        return `
            <td class="px-1 py-1 col-name"><input type="text" class="input-field-sm name-field packaging-item-name" placeholder=" "></td>
            <td class="px-1 py-1 col-price"><input type="number" class="input-field-sm max-w-24 packaging-purchase-price" placeholder=" " min="0" step="0.01"></td>
            <td class="px-1 py-1 col-unit"><input type="text" class="input-field-sm max-w-20 packaging-purchase-unit" placeholder=" "></td>
            <td class="px-1 py-1 col-number"><input type="number" class="input-field-sm max-w-20 packaging-unit-quantity" placeholder=" " min="1" step="1"></td>
            <td class="px-1 py-1 text-xs sm:text-sm packaging-unit-cost text-center col-price">0.00</td>
            <td class="px-1 py-1 col-number"><input type="number" class="input-field-sm max-w-20 packaging-quantity-used" placeholder=" " min="0" step="1"></td>
            <td class="px-1 py-1 text-xs sm:text-sm packaging-subtotal text-center col-price">0.00</td>
            <td class="px-1 py-1 text-center col-action"><button class="btn btn-danger btn-sm text-xs !p-1" onclick="window.removeRow('packagingRow-${idx}')">ç§»é™¤</button></td>
        `;
    }
    
    function addRowWithInputListeners(tableBody, rowId, htmlContent) {
        const row = tableBody.insertRow();
        row.id = rowId;
        row.innerHTML = htmlContent;
        row.querySelectorAll('input.input-field-sm').forEach(input => {
            input.addEventListener('focus', handleInputFocus);
            input.addEventListener('blur', handleInputBlur);
            input.addEventListener('input', calculateAllCosts);
             if (input.value) input.classList.add('has-value'); 
        });
        calculateAllCosts();
    }


    window.addGemstoneRow = function() {
        gemstoneRowIdx++;
        addRowWithInputListeners(el.gemstoneRows, `gemstoneRow-${gemstoneRowIdx}`, createMaterialRowHTML('gemstone', gemstoneRowIdx));
    }

    window.addAccessoryRow = function() {
        accessoryRowIdx++;
        addRowWithInputListeners(el.accessoryRows, `accessoryRow-${accessoryRowIdx}`, createMaterialRowHTML('accessory', accessoryRowIdx));
    }
    
    window.addPackagingRow = function() {
        packagingRowIdx++;
        addRowWithInputListeners(el.packagingRows, `packagingRow-${packagingRowIdx}`, createPackagingRowHTML(packagingRowIdx));
    }
    
    window.removeRow = function(rowId) {
        const rowElement = document.getElementById(rowId);
        if (rowElement) rowElement.remove();
        calculateAllCosts();
    }

    function highlightValueChange(element, value) { 
        if (!element) return;
        const formattedValue = formatCurrency(value);
        if (element.textContent !== formattedValue) {
            element.textContent = formattedValue;
            element.classList.remove('value-changed'); 
            void element.offsetWidth; 
            element.classList.add('value-changed');
        } else {
            element.textContent = formattedValue; 
        }
    }

    function calculateSpecificMaterialCosts(rowsContainer, typePrefix, totalSpan) {
        let totalCost = 0;
        rowsContainer.querySelectorAll('tr').forEach(row => {
            const purchasePrice = parseFloat(row.querySelector(`.${typePrefix}-purchase-price`).value) || 0;
            const unitQuantity = parseFloat(row.querySelector(`.${typePrefix}-unit-quantity`).value) || 1;
            const quantityUsed = parseFloat(row.querySelector(`.${typePrefix}-quantity-used`).value) || 0;
            const unitCost = (purchasePrice && unitQuantity > 0) ? (purchasePrice / unitQuantity) : 0;
            const subtotal = unitCost * quantityUsed;
            row.querySelector(`.${typePrefix}-unit-cost`).textContent = formatCurrency(unitCost);
            row.querySelector(`.${typePrefix}-subtotal`).textContent = formatCurrency(subtotal);
            totalCost += subtotal;
        });
        highlightValueChange(totalSpan, totalCost);
        return totalCost;
    }
    
    function calculatePackagingCosts() {
        let totalPackagingCost = 0;
        el.packagingRows.querySelectorAll('tr').forEach(row => {
            const purchasePrice = parseFloat(row.querySelector('.packaging-purchase-price').value) || 0;
            const unitQuantity = parseFloat(row.querySelector('.packaging-unit-quantity').value) || 1; 
            const quantityUsed = parseFloat(row.querySelector('.packaging-quantity-used').value) || 0;
            
            const unitCost = (purchasePrice && unitQuantity > 0) ? (purchasePrice / unitQuantity) : 0;
            const subtotal = unitCost * quantityUsed;

            row.querySelector('.packaging-unit-cost').textContent = formatCurrency(unitCost);
            row.querySelector('.packaging-subtotal').textContent = formatCurrency(subtotal);
            totalPackagingCost += subtotal;
        });
        highlightValueChange(el.totalPackagingCostSpan, totalPackagingCost);
        return totalPackagingCost;
    }


    function calculateWastageCost(totalGemstoneCost, totalAccessoryCost) {
        const totalMaterialCost = totalGemstoneCost + totalAccessoryCost;
        const wastageRate = parseFloat(el.wastageRateInput.value) || 0;
        const wastageCost = totalMaterialCost * (wastageRate / 100);
        highlightValueChange(el.wastageCostSpan, wastageCost);
        return wastageCost;
    }

    function calculateLaborCost() {
        const laborHours = parseFloat(el.laborHoursInput.value) || 0;
        const hourlyRate = parseFloat(el.hourlyRateInput.value) || 0;
        const laborCost = laborHours * hourlyRate;
        highlightValueChange(el.laborCostSpan, laborCost);
        return laborCost;
    }
    
    function getDesignAndOperatingCosts() {
        const designFee = parseFloat(el.fixedDesignFeeInput.value) || 0;
        const operatingCost = parseFloat(el.allocatedOperatingCostInput.value) || 0;
        return { designFee, operatingCost };
    }

    function calculateAllCosts() {
        const totalGemstoneCost = calculateSpecificMaterialCosts(el.gemstoneRows, 'gemstone', el.totalGemstoneCostSpan);
        const totalAccessoryCost = calculateSpecificMaterialCosts(el.accessoryRows, 'accessory', el.totalAccessoryCostSpan);
        const { designFee, operatingCost } = getDesignAndOperatingCosts();
        const wastageCost = calculateWastageCost(totalGemstoneCost, totalAccessoryCost);
        const laborCost = calculateLaborCost();
        const totalPackagingCost = calculatePackagingCosts(); 
        const totalDirectCost = totalGemstoneCost + totalAccessoryCost + designFee + operatingCost + wastageCost + laborCost + totalPackagingCost;

        highlightValueChange(el.summaryGemstoneCost, totalGemstoneCost);
        highlightValueChange(el.summaryAccessoryCost, totalAccessoryCost);
        highlightValueChange(el.summaryDesignFee, designFee);
        highlightValueChange(el.summaryOperatingCost, operatingCost);
        highlightValueChange(el.summaryWastageCostSpan, wastageCost); 
        highlightValueChange(el.summaryLaborCostSpan, laborCost); 
        highlightValueChange(el.summaryPackagingCostSpan, totalPackagingCost); 
        highlightValueChange(el.totalDirectCostSpan, totalDirectCost);


        const profitMarkup = parseFloat(el.profitMarkupInput.value) || 1;
        const suggestedRetailPrice = totalDirectCost * profitMarkup;
        highlightValueChange(el.suggestedRetailPriceSpan, suggestedRetailPrice);
        

        updateChartData(totalGemstoneCost, totalAccessoryCost, designFee, operatingCost, wastageCost, laborCost, totalPackagingCost);
    }

    function initChart() {
        Chart.defaults.font.family = 'Inter, sans-serif';
        costChart = new Chart(el.costBreakdownChartCanvas, {
            type: 'pie',
            data: {
                labels: ['å®çŸ³æˆæœ¬', 'é…ä»¶æˆæœ¬', 'è®¾è®¡æˆæœ¬', 'è¿è¥æˆæœ¬', 'æŸè€—æˆæœ¬', 'äººå·¥æˆæœ¬', 'åŒ…è£…æˆæœ¬'],
                datasets: [{
                    label: 'æˆæœ¬æ„æˆ', data: [0,0,0,0,0,0,0],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'],
                    borderWidth: 2, hoverOffset: 4 
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: {
                    duration: 800, 
                    easing: 'easeOutQuart'
                },
                plugins: { 
                    legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 }}}, 
                    tooltip: { 
                        callbacks: { label: (c) => `${c.label}: Â¥${formatCurrency(c.parsed)}` },
                        padding: 10, cornerRadius: 4
                    } 
                }
            }
        });
        const preferredTheme = localStorage.getItem(themeKey) || 'light';
        updateChartColors(preferredTheme); 
    }

    function updateChartData(gem, acc, design, op, waste, labor, pack) {
        if (!costChart) return;
        const data = [gem, acc, design, op, waste, labor, pack];
        const allZero = data.every(item => item === 0);
        costChart.data.datasets[0].data = allZero ? Array(data.length).fill(1) : data; 
        costChart.update();
    }
    
    async function populateSavedProductsSelect() {
        if (!userProductsCollection) {
            console.warn("User products collection not initialized for populateSavedProductsSelect.");
            showLoading(false);
            return;
        }
        try {
            const q = query(userProductsCollection, orderBy("productName"));
            onSnapshot(q, (querySnapshot) => {
                const products = [];
                querySnapshot.forEach((doc) => {
                    products.push({ firestoreId: doc.id, ...doc.data() });
                });
                
                el.savedProductsSelect.innerHTML = '<option value="">-- é€‰æ‹©å·²å­˜æ¡£äº§å“ --</option>';
                products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.firestoreId; 
                    option.textContent = `${p.productSKU || 'N/A'} - ${p.productName || 'æœªå‘½åäº§å“'}`;
                    el.savedProductsSelect.appendChild(option);
                });
                showLoading(false);
            }, (error) => {
                console.error("Error fetching products with onSnapshot: ", error);
                alert("åŠ è½½äº§å“åˆ—è¡¨å®æ—¶æ›´æ–°å¤±è´¥: " + error.message);
                showLoading(false);
            });
        } catch (error) {
            console.error("Error setting up product listener in populate: ", error);
            alert("è®¾ç½®äº§å“ç›‘å¬å¤±è´¥: " + error.message);
            showLoading(false);
        }
    }
    
    function clearForm(isInitialLoad = false) {
        document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea, select').forEach(input => {
            if (input.tagName === 'SELECT') {
                if (input.id === 'savedProducts' && !isInitialLoad) { /* Do nothing */ }
                else { input.selectedIndex = 0; }
            } else if(input.id === 'wastageRate') input.value = '5';
            else if(input.id === 'laborHours') input.value = '0.75';
            else if(input.id === 'hourlyRate') input.value = '60';
            else if(input.id === 'profitMarkup') input.value = '3';
            else if(input.id === 'fixedDesignFee' || input.id === 'allocatedOperatingCost') input.value = '0';
            else input.value = '';
            if (input.classList.contains('has-value') && input.type !== 'date') { 
                 input.classList.remove('has-value');
            } else if (input.type === 'date' && !input.value) { 
                input.classList.remove('has-value');
            }
        });
        el.gemstoneRows.innerHTML = ''; gemstoneRowIdx = 0;
        el.accessoryRows.innerHTML = ''; accessoryRowIdx = 0;
        el.packagingRows.innerHTML = ''; packagingRowIdx = 0;
        
        if(isInitialLoad){ addGemstoneRow(); addAccessoryRow(); addPackagingRow(); }
        calculateAllCosts();
    }

    async function saveCurrentProduct() {
        if (!userProductsCollection) { alert("æ•°æ®åº“æœªè¿æ¥æˆ–ç”¨æˆ·æœªè®¤è¯ï¼Œè¯·ç¨åå†è¯•ã€‚"); return; }
        const productSKU = el.productSKU.value.trim();
        const productName = el.productName.value.trim();
        if (!productSKU && !productName) { alert('äº§å“æ¬¾å¼ç¼–å· (SKU) å’Œäº§å“åç§°ä¸èƒ½ä¸ºç©ºï¼'); return; }
        
        const productData = {
            productSKU: productSKU, productName: productName,
            designDate: el.designDate.value, designerName: el.designerName.value, productDescription: el.productDescription.value,
            gemstoneItems: Array.from(el.gemstoneRows.querySelectorAll('tr')).map(r => ({ name: r.querySelector('.gemstone-name').value, purchasePrice: r.querySelector('.gemstone-purchase-price').value, purchaseUnit: r.querySelector('.gemstone-purchase-unit').value, unitQuantity: r.querySelector('.gemstone-unit-quantity').value, quantityUsed: r.querySelector('.gemstone-quantity-used').value, })),
            accessoryItems: Array.from(el.accessoryRows.querySelectorAll('tr')).map(r => ({ name: r.querySelector('.accessory-name').value, purchasePrice: r.querySelector('.accessory-purchase-price').value, purchaseUnit: r.querySelector('.accessory-purchase-unit').value, unitQuantity: r.querySelector('.accessory-unit-quantity').value, quantityUsed: r.querySelector('.accessory-quantity-used').value, })),
            packagingItems: Array.from(el.packagingRows.querySelectorAll('tr')).map(r => ({ 
                name: r.querySelector('.packaging-item-name').value, 
                purchasePrice: r.querySelector('.packaging-purchase-price').value,
                purchaseUnit: r.querySelector('.packaging-purchase-unit').value,
                unitQuantity: r.querySelector('.packaging-unit-quantity').value,
                quantityUsed: r.querySelector('.packaging-quantity-used').value,
            })),
            fixedDesignFee: el.fixedDesignFeeInput.value, allocatedOperatingCost: el.allocatedOperatingCostInput.value,
            wastageRate: el.wastageRateInput.value, laborHours: el.laborHoursInput.value, hourlyRate: el.hourlyRateInput.value,
            profitMarkup: el.profitMarkupInput.value,
            updatedAt: serverTimestamp() 
        };

        showLoading(true);
        try {
            const selectedProductId = el.savedProductsSelect.value; 
            let operationPerformed = '';

            if (selectedProductId) {
                 if(confirm(`æ‚¨æ­£åœ¨ç¼–è¾‘å·²åŠ è½½çš„äº§å“ã€‚\næ‚¨è¦æ›´æ–° "${productName}" (SKU: ${productSKU}) å—ï¼Ÿ`)){
                    const productDocRef = doc(userProductsCollection, selectedProductId);
                    await setDoc(productDocRef, productData, { merge: true }); 
                    operationPerformed = `äº§å“ "${productName}" å·²æ›´æ–°ï¼`;
                } else { showLoading(false); return; }
            } else {
                productData.createdAt = serverTimestamp();
                const docRef = await addDoc(userProductsCollection, productData);
                operationPerformed = `äº§å“ "${productName}" å·²æ–°å¢ä¿å­˜ï¼`;
            }
            if(operationPerformed) alert(operationPerformed);

        } catch (error) {
            console.error("Error saving product: ", error);
            alert("ä¿å­˜äº§å“å¤±è´¥: " + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function loadSelectedProduct() {
        if (!userProductsCollection) { alert("æ•°æ®åº“æœªè¿æ¥æˆ–ç”¨æˆ·æœªè®¤è¯ï¼Œè¯·ç¨åå†è¯•ã€‚"); return; }
        const productId = el.savedProductsSelect.value; 
        if (!productId) { alert('è¯·å…ˆä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªå·²å­˜æ¡£çš„äº§å“ï¼'); return; }
        
        showLoading(true);
        try {
            const productDocRef = doc(userProductsCollection, productId);
            const productSnap = await getDoc(productDocRef);

            if (!productSnap.exists()) {
                alert('æœªæ‰¾åˆ°é€‰å®šçš„äº§å“æ•°æ®ï¼'); showLoading(false); return;
            }
            const product = productSnap.data();

            clearForm(false); 
            el.productSKU.value = product.productSKU || ''; el.productName.value = product.productName || '';
            el.designDate.value = product.designDate || ''; el.designerName.value = product.designerName || '';
            el.productDescription.value = product.productDescription || '';
            (product.gemstoneItems || []).forEach(item => { addGemstoneRow(); const r = el.gemstoneRows.lastChild; r.querySelector('.gemstone-name').value = item.name; r.querySelector('.gemstone-purchase-price').value = item.purchasePrice; r.querySelector('.gemstone-purchase-unit').value = item.purchaseUnit; r.querySelector('.gemstone-unit-quantity').value = item.unitQuantity; r.querySelector('.gemstone-quantity-used').value = item.quantityUsed; });
            if (!el.gemstoneRows.hasChildNodes() && (product.gemstoneItems || []).length === 0) addGemstoneRow();
            (product.accessoryItems || []).forEach(item => { addAccessoryRow(); const r = el.accessoryRows.lastChild; r.querySelector('.accessory-name').value = item.name; r.querySelector('.accessory-purchase-price').value = item.purchasePrice; r.querySelector('.accessory-purchase-unit').value = item.purchaseUnit; r.querySelector('.accessory-unit-quantity').value = item.unitQuantity; r.querySelector('.accessory-quantity-used').value = item.quantityUsed; });
            if (!el.accessoryRows.hasChildNodes() && (product.accessoryItems || []).length === 0) addAccessoryRow();
            
            (product.packagingItems || []).forEach(item => { 
                addPackagingRow(); 
                const r = el.packagingRows.lastChild; 
                r.querySelector('.packaging-item-name').value = item.name; 
                r.querySelector('.packaging-purchase-price').value = item.purchasePrice;
                r.querySelector('.packaging-purchase-unit').value = item.purchaseUnit;
                r.querySelector('.packaging-unit-quantity').value = item.unitQuantity;
                r.querySelector('.packaging-quantity-used').value = item.quantityUsed;
            });
            if (!el.packagingRows.hasChildNodes() && (product.packagingItems || []).length === 0) addPackagingRow();

            el.fixedDesignFeeInput.value = product.fixedDesignFee || '0'; el.allocatedOperatingCostInput.value = product.allocatedOperatingCost || '0';
            el.wastageRateInput.value = product.wastageRate || '5'; el.laborHoursInput.value = product.laborHours || '0.75';
            el.hourlyRateInput.value = product.hourlyRate || '60';
            el.profitMarkupInput.value = product.profitMarkup || '3';
            
            document.querySelectorAll('.input-field, .input-field-sm').forEach(input => {
                if(input.value || (input.type === 'date' && input.value) ) input.classList.add('has-value');
                else input.classList.remove('has-value');
            });

            calculateAllCosts(); 
            alert(`äº§å“ "${product.productName}" æ•°æ®å·²åŠ è½½ï¼`);
        } catch (error) {
            console.error("Error loading product: ", error);
            alert("åŠ è½½äº§å“å¤±è´¥: " + error.message);
        } finally {
            showLoading(false);
        }
    }
    
    async function deleteSelectedProduct() {
        if (!userProductsCollection) { alert("æ•°æ®åº“æœªè¿æ¥æˆ–ç”¨æˆ·æœªè®¤è¯ï¼Œè¯·ç¨åå†è¯•ã€‚"); return; }
        const productId = el.savedProductsSelect.value; 
        const selectedOption = el.savedProductsSelect.options[el.savedProductsSelect.selectedIndex];
        const productName = selectedOption ? selectedOption.text.split(' - ')[1] || "é€‰ä¸­çš„äº§å“" : "é€‰ä¸­çš„äº§å“";

        if (!productId) { alert('è¯·å…ˆä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„äº§å“ï¼'); return; }
        if (!confirm(`æ‚¨ç¡®å®šè¦åˆ é™¤äº§å“ "${productName}" å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
        
        showLoading(true);
        try {
            const productDocRef = doc(userProductsCollection, productId);
            await deleteDoc(productDocRef);
            clearForm(true); 
            alert(`äº§å“ "${productName}" å·²åˆ é™¤ï¼`);
        } catch (error) {
            console.error("Error deleting product: ", error);
            alert("åˆ é™¤äº§å“å¤±è´¥: " + error.message);
        } finally {
            showLoading(false);
        }
    }

    function generateProductReport() {
        const sku = el.productSKU.value || 'æœªå¡«å†™'; const name = el.productName.value || 'æœªå‘½åäº§å“';
        if (sku === 'æœªå¡«å†™' && name === 'æœªå‘½åäº§å“' && parseFloat(el.totalDirectCostSpan.textContent) === 0) { alert("è¯·è¾“å…¥æˆ–åŠ è½½äº§å“æ•°æ®ä»¥ç”ŸæˆæŠ¥å‘Šã€‚"); return; }
        let reportHTML = `<div class="text-center mb-6"><h3 class="text-xl font-semibold" style="color: var(--accent-teal);">${name} (SKU: ${sku})</h3></div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3"> <p><strong>è®¾è®¡æ—¥æœŸ:</strong> ${el.designDate.value || 'N/A'}</p> <p><strong>è®¾è®¡å¸ˆ:</strong> ${el.designerName.value || 'N/A'}</p> <p class="sm:col-span-2"><strong>äº§å“æè¿°:</strong> ${el.productDescription.value || 'N/A'}</p> </div> <hr class="my-4" style="border-color: var(--border-color);"> <h4 class="text-lg font-semibold mb-2" style="color: var(--text-secondary);">æˆæœ¬æ˜ç»†:</h4> <div class="space-y-1">`;
        const costs = [ { label: 'å®çŸ³æ€»æˆæœ¬', value: el.summaryGemstoneCost.textContent }, { label: 'é…ä»¶æ€»æˆæœ¬', value: el.summaryAccessoryCost.textContent }, { label: 'å›ºå®šè®¾è®¡è´¹', value: el.summaryDesignFee.textContent }, { label: 'è¿è¥æˆæœ¬åˆ†æ‘Š', value: el.summaryOperatingCost.textContent }, { label: 'æŸè€—æˆæœ¬', value: el.summaryWastageCostSpan.textContent }, { label: 'äººå·¥æˆæœ¬ (åˆ¶ä½œ)', value: el.summaryLaborCostSpan.textContent }, { label: 'åŒ…è£…æ€»æˆæœ¬', value: el.summaryPackagingCostSpan.textContent }, ];
        costs.forEach(cost => { reportHTML += `<div class="flex justify-between" style="color: var(--text-primary);"><span>${cost.label}:</span><span class="font-medium">Â¥${cost.value}</span></div>`; });
        reportHTML += `</div> <div class="flex justify-between mt-2 pt-2 font-bold text-base total-summary-item"><span>ç›´æ¥æ€»æˆæœ¬:</span><span>Â¥${el.totalDirectCostSpan.textContent}</span></div> <hr class="my-4" style="border-color: var(--border-color);"> <h4 class="text-lg font-semibold mb-2" style="color: var(--text-secondary);">å®šä»·ä¿¡æ¯:</h4> <div class="flex justify-between" style="color: var(--text-primary);"><span>ç›®æ ‡åˆ©æ¶¦å€æ•°:</span><span class="font-medium">${el.profitMarkupInput.value}</span></div> <div class="flex justify-between text-xl font-bold mt-1" style="color: var(--accent-teal);"><span>å»ºè®®é›¶å”®ä»· (SRP):</span><span>Â¥${el.suggestedRetailPriceSpan.textContent}</span></div>`;
        el.reportContent.innerHTML = reportHTML; el.reportModal.classList.remove('hidden');
    }
    
    async function callGeminiAPI(prompt, modalTitle, buttonElement) { 
        showGeminiLoading(true, buttonElement); 
        el.geminiModalTitle.textContent = modalTitle;
        el.geminiResponseText.textContent = 'æ­£åœ¨ç”Ÿæˆå†…å®¹...';
        el.geminiResponseModal.classList.remove('hidden');

        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error (${response.status}): ${errorData.error?.message || 'Unknown error'}`);
            }
            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                el.geminiResponseText.textContent = text;
            } else {
                console.error('Unexpected Gemini API response structure:', result);
                el.geminiResponseText.textContent = 'æœªèƒ½è·å–æœ‰æ•ˆå›å¤ï¼Œè¯·æ£€æŸ¥APIå“åº”ç»“æ„ã€‚';
            }
        } catch (error) {
            console.error('Error calling Gemini API:', error);
            el.geminiResponseText.textContent = `è°ƒç”¨AIæœåŠ¡æ—¶å‡ºé”™ï¼š${error.message}`;
        } finally {
            showGeminiLoading(false, buttonElement); 
        }
    }

    el.enhanceDescriptionBtn.addEventListener('click', (event) => {
        const productName = el.productName.value || "æœªå‘½åäº§å“";
        const productSKU = el.productSKU.value || "æ— SKU";
        const currentDescription = el.productDescription.value || "æ— ";
        
        let materials = [];
        el.gemstoneRows.querySelectorAll('tr').forEach(row => {
            const name = row.querySelector('.gemstone-name').value;
            if (name) materials.push(name);
        });
        el.accessoryRows.querySelectorAll('tr').forEach(row => {
            const name = row.querySelector('.accessory-name').value;
            if (name) materials.push(name);
        });
        const materialString = materials.length > 0 ? materials.join(', ') : 'æœªæŒ‡å®š';

        const prompt = `è¯·ä¸ºä¸€æ¬¾åä¸º "${productName}" (SKU: ${productSKU}) çš„ç å®äº§å“ä¼˜åŒ–ä»¥ä¸‹æè¿°ã€‚
        å½“å‰æè¿°: "${currentDescription}"
        ä¸»è¦æè´¨åŒ…æ‹¬: ${materialString}ã€‚
        è¯·ç”Ÿæˆä¸€æ®µæ›´å¸å¼•äººã€æ›´ä¸“ä¸šçš„è¥é”€æè¿°ï¼Œçªå‡ºå…¶ç‰¹ç‚¹å’Œé­…åŠ›ï¼Œé€‚åˆç”¨äºç”µå•†å¹³å°æˆ–ç¤¾äº¤åª’ä½“ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ã€‚`;
        callGeminiAPI(prompt, 'âœ¨ AI äº§å“æè¿°ä¼˜åŒ–', event.currentTarget); 
    });

    el.getCostAnalysisBtn.addEventListener('click', (event) => {
        const costs = {
            "å®çŸ³æ€»æˆæœ¬": el.summaryGemstoneCost.textContent,
            "é…ä»¶æ€»æˆæœ¬": el.summaryAccessoryCost.textContent,
            "å›ºå®šè®¾è®¡è´¹": el.summaryDesignFee.textContent,
            "è¿è¥æˆæœ¬åˆ†æ‘Š": el.summaryOperatingCost.textContent,
            "æŸè€—æˆæœ¬": el.summaryWastageCostSpan.textContent,
            "äººå·¥æˆæœ¬": el.summaryLaborCostSpan.textContent,
            "åŒ…è£…æ€»æˆæœ¬": el.summaryPackagingCostSpan.textContent,
            "ç›´æ¥æ€»æˆæœ¬": el.totalDirectCostSpan.textContent,
            "å»ºè®®é›¶å”®ä»·": el.suggestedRetailPriceSpan.textContent,
            "åˆ©æ¶¦å€æ•°": el.profitMarkupInput.value
        };
        const costString = Object.entries(costs).map(([key, value]) => `${key}: Â¥${value}`).join('\n');
        
        const prompt = `æˆ‘æœ‰ä¸€æ¬¾ç å®äº§å“ï¼Œå…¶æˆæœ¬æ„æˆå¦‚ä¸‹ï¼š
        ${costString}
        è¯·åŸºäºè¿™äº›æˆæœ¬æ•°æ®ï¼Œæä¾›ä¸€äº›å…³äºæˆæœ¬æ§åˆ¶ã€æ½œåœ¨ç›ˆåˆ©ç‚¹åˆ†ææˆ–å®šä»·ç­–ç•¥æ–¹é¢çš„å»ºè®®å’Œæ€è€ƒç‚¹ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œå¹¶ä»¥æ˜“äºç†è§£çš„æ–¹å¼å‘ˆç°ã€‚`;
        callGeminiAPI(prompt, 'âœ¨ AI æˆæœ¬åˆ†æä¸å»ºè®®', event.currentTarget); 
    });
    
    el.closeGeminiModalBtn.addEventListener('click', () => el.geminiResponseModal.classList.add('hidden'));
    el.closeGeminiModalBtnSecondary.addEventListener('click', () => el.geminiResponseModal.classList.add('hidden'));
    el.copyGeminiResponseBtn.addEventListener('click', () => {
        const textToCopy = el.geminiResponseText.textContent;
        const textArea = document.createElement("textarea");
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        } catch (err) {
            console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬: ', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
        }
        document.body.removeChild(textArea);
    });


    el.themeToggle.addEventListener('click', toggleTheme);
    el.addGemstoneRowBtn.addEventListener('click', addGemstoneRow);
    el.addAccessoryRowBtn.addEventListener('click', addAccessoryRow);
    el.addPackagingRowBtn.addEventListener('click', addPackagingRow);
    
    document.querySelectorAll('.input-field, .input-field-sm').forEach(input => {
        input.addEventListener('input', () => {
            input.classList.toggle('has-value', input.value !== '');
            if (input.closest('.form-group') || input.closest('table')) { 
                 if(['fixedDesignFee', 'allocatedOperatingCost', 'wastageRate', 'laborHours', 'hourlyRate', 'profitMarkup'].includes(input.id) || input.closest('table')) {
                    calculateAllCosts();
                 }
            }
        });
        input.addEventListener('blur', () => { 
            input.classList.toggle('has-value', input.value !== '');
        });
    });


    el.saveProductBtn.addEventListener('click', saveCurrentProduct);
    el.loadProductBtn.addEventListener('click', loadSelectedProduct);
    el.deleteProductBtn.addEventListener('click', deleteSelectedProduct);
    el.generateReportBtn.addEventListener('click', generateProductReport);
    el.closeReportModalBtn.addEventListener('click', () => el.reportModal.classList.add('hidden'));
    el.closeReportModalBtnSecondary.addEventListener('click', () => el.reportModal.classList.add('hidden'));

    document.addEventListener('DOMContentLoaded', async () => {
        if(el.currentYearSpan) el.currentYearSpan.textContent = new Date().getFullYear();
        const preferredTheme = localStorage.getItem(themeKey) || 'light';
        applyTheme(preferredTheme);
        
        setupInputInteractions(); 
        await initializeFirebase(); 
        
        clearForm(true); 
        initChart();
    });

</script>
</body>
</html>
